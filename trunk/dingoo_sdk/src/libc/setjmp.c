#include "setjmp.h"

int setjmp(jmp_buf env) {
	asm (
		"sw  $2,   8(%0);\n\t"
		"sw  $3,  12(%0);\n\t"
		"sw  $4,  16(%0);\n\t"
		"sw  $5,  20(%0);\n\t"
		"sw  $6,  24(%0);\n\t"
		"sw  $7,  28(%0);\n\t"
		"sw  $8,  32(%0);\n\t"
		"sw  $9,  36(%0);\n\t"
		"sw $10,  40(%0);\n\t"
		"sw $11,  44(%0);\n\t"
		"sw $12,  48(%0);\n\t"
		"sw $13,  52(%0);\n\t"
		"sw $14,  56(%0);\n\t"
		"sw $15,  60(%0);\n\t"
		"sw $16,  64(%0);\n\t"
		"sw $17,  68(%0);\n\t"
		"sw $18,  72(%0);\n\t"
		"sw $19,  76(%0);\n\t"
		"sw $20,  80(%0);\n\t"
		"sw $21,  84(%0);\n\t"
		"sw $22,  88(%0);\n\t"
		"sw $23,  92(%0);\n\t"
		"sw $24,  96(%0);\n\t"
		"sw $25, 100(%0);\n\t"
		"sw $26, 104(%0);\n\t"
		"sw $27, 108(%0);\n\t"
		"sw $28, 112(%0);\n\t"
		"sw $29, 116(%0);\n\t"
		"sw $30, 120(%0);\n\t"
		"sw $31, 124(%0);\n\t"
		".set noat\n\t"
		"mflo $at;\n\t"
		"sw $at, 0(%0)\n\t"
		"mfhi $at;\n\t"
		"sw $at, 4(%0);\n\t"
		".set at\n\t"
		: : "r"((uintptr_t*)env)
		);
	return 0;
}

void longjmp(jmp_buf env, int value) {
	asm (
		".set noat\n\t"
		"lw $at, 0(%0)\n\t"
		"mtlo $at;\n\t"
		"lw $at, 4(%0);\n\t"
		"mthi $at;\n\t"
		".set at\n\t"
		"or  $2, $0, %1;\n\t"
		"lw  $3,   8(%0);\n\t"
		"lw  $4,  12(%0);\n\t"
		"lw  $5,  16(%0);\n\t"
		"lw  $6,  20(%0);\n\t"
		"lw  $7,  24(%0);\n\t"
		"lw  $8,  28(%0);\n\t"
		"lw  $9,  32(%0);\n\t"
		"lw $10,  36(%0);\n\t"
		"lw $11,  40(%0);\n\t"
		"lw $12,  44(%0);\n\t"
		"lw $13,  48(%0);\n\t"
		"lw $14,  52(%0);\n\t"
		"lw $15,  56(%0);\n\t"
		"lw $16,  60(%0);\n\t"
		"lw $17,  64(%0);\n\t"
		"lw $18,  68(%0);\n\t"
		"lw $19,  72(%0);\n\t"
		"lw $20,  76(%0);\n\t"
		"lw $21,  80(%0);\n\t"
		"lw $22,  84(%0);\n\t"
		"lw $23,  88(%0);\n\t"
		"lw $24,  92(%0);\n\t"
		"lw $25,  96(%0);\n\t"
		"lw $26, 100(%0);\n\t"
		"lw $27, 104(%0);\n\t"
		"lw $28, 108(%0);\n\t"
		"lw $29, 112(%0);\n\t"
		"lw $30, 116(%0);\n\t"
		"lw $31, 120(%0);\n\t"
		"jr $ra;\n\t"
		"nop"
		: : "r"((uintptr_t*)env), "r"(value)
		);
}
